project: snap-confine

environment:
    REUSE_PROJECT: $(echo $REUSE_PROJECT)
    PATH: /snap/bin:$PATH

backends:
    linode:
        key: "$(HOST: echo $SPREAD_LINODE_KEY)"
        systems:
            - ubuntu-16.04-64-grub
            # - ubuntu-16.04-32-grub

path: /remote/path/

exclude:
    - .git
    - debian
    - autom4te.cache

prepare: |
    [ "$REUSE_PROJECT" != 1 ] || exit 0
    if [ -f /etc/apt/apt.conf.d/95cloud-init-proxy ]; then
        rm -f /etc/apt/apt.conf.d/95cloud-init-proxy
    fi
    if [ -n "${APT_PROXY:-}" ]; then
        printf 'Acquire::http::Proxy "%s";\n' "$APT_PROXY" > /etc/apt/apt.conf.d/00aptproxy
    fi
    ./spread-tests/spread-prepare.sh

suites:
    spread-tests/main/:
        summary: Full-system tests for snap-confine
        restore-each: |
            # NOTE: before snapd discards namespaces on snap removal
            # we have to do it ourselves. All of the tests use one
            # snap so this is easier to work with.
            /usr/lib/snapd/snap-discard-ns snapd-hacker-toolbelt
    spread-tests/regression/:
        summary: Regression tests for past bug-fixes
        restore-each: |
            /usr/lib/snapd/snap-discard-ns snapd-hacker-toolbelt
