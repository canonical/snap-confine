summary: Ensure that XDG_RUNTIME_DIR directory is created by snap-confine
# This is blacklisted on debian because debian doesn't use apparmor yet
systems: [-debian-8]
details: |
    This test checks that XDG_RUNTIME_DIR is actually created and is owned by
    the correct user.
prepare: |
    echo "Having installed the snapd-hacker-toolbelt snap"
    snap install snapd-hacker-toolbelt
    echo "And having created a test user with a home directory"
    useradd test
    mkdir /home/test
    chown test.test /home/test
execute: |
    echo "We can set a per-snap XDG_RUNTIME_DIR (until snapd does this)"
    export XDG_RUNTIME_DIR="/run/user/$(id -u test)/snap.snapd-hacker-toolbelt"
    echo "We can now run snapd-hacker-toolbelt.busybox true as the test user"
    su -l -c "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR /snap/bin/snapd-hacker-toolbelt.busybox true" test
    echo "And see that the XDG_RUNTIME_DIR directory was created"
    [ -d "$XDG_RUNTIME_DIR" ]
    echo "And is owned by the right user and group"
    [ "$(stat -c '%U.%G' /)" = root.root ]
    [ "$(stat -c '%U.%G' /run)" = root.root ]
    [ "$(stat -c '%U.%G' /run/user)" = root.root ]
    [ "$(stat -c '%U.%G' /run/user/$(id -u test))" = test.test ]
    [ "$(stat -c '%U.%G' /run/user/$(id -u test)/snap.snapd-hacker-toolbelt)" = test.test ]
    echo "And has the right permissions"
    [ "$(stat -c '%a' /)" = 755 ]
    [ "$(stat -c '%a' /run)" = 755 ]
    [ "$(stat -c '%a' /run/user)" = 755 ]
    [ "$(stat -c '%a' /run/user/$(id -u test))" = 700 ]
    [ "$(stat -c '%a' /run/user/$(id -u test)/snap.snapd-hacker-toolbelt)" = 755 ]
    # Sanity check when we remove the XDG_RUNTIME_DIR override above
    [ "$(stat -c '%a' $XDG_RUNTIME_DIR)" = 755 ]
    [ "$(stat -c '%U.%G' $XDG_RUNTIME_DIR)" = test.test ]
restore: |
    rm -rf "/home/test"
    rm -rf "/run/user/$(id -u test)"
    userdel test
    snap remove snapd-hacker-toolbelt
