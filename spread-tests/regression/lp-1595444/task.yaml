summary: Regression check for https://bugs.launchpad.net/snap-confine/+bug/1595444
# This is blacklisted on debian because we first have to get the dpkg-vendor patches
systems: [-debian-8]
details: |
    This task checks the behavior of snap-confine when it is started from
    a directory that doesn't exist in the execution environment (chroot).
prepare: |
    echo "Having installed the snapd-hacker-toolbelt snap"
    "$SPREAD_PATH/spread-tests/snap-install" snapd-hacker-toolbelt
    mkdir -p "/foo"
execute: |
    echo "We can go to a location that is available in all snaps (/tmp)"
    echo "We can run the 'cwd' tool from busybox and it reports /tmp" 
    [ "$(cd /tmp && /snap/bin/snapd-hacker-toolbelt.busybox pwd)" = "/tmp" ]
    echo "But if we go to a location that is not available to snaps (e.g. /foo)"
    echo "Then snap-confine moves us to /var/lib/snapd/void"
    [ "$(cd /foo && /snap/bin/snapd-hacker-toolbelt.busybox pwd)" = "/var/lib/snapd/void" ]
    echo "And that directory is not readable or writable"
    # NOTE: the printed message differs between dash and bash:
    #
    # In dash/busybox/sh it is:
    # ls: .: Permission denied
    #
    # In bash it is:
    # ls: cannot open directory '.': Permission denied
    #
    # The code below uses dash/sh
    [ "$(cd /foo && /snap/bin/snapd-hacker-toolbelt.busybox sh -c 'ls' 2>&1)" = "ls: .: Permission denied" ];
restore: |
    snap remove snapd-hacker-toolbelt
    rm -rf /var/snap/snapd-hacker-toolbelt
    rmdir /foo
    # NOTE: snapd-hacker-toolbelt is blocked by apparmor from reading /var/lib/snapd/void
    dmesg -c
